## Stanプログラムの実行

この章は，コンパイルされたStanモデルがどのようにサンプリングを行いながら実行されるかについて解説します。最適化でも同じデータを読み，初期化を行うステップがありますが，最適化はむしろサンプリングのために行われるものです。

ここの概略では，このパートの以下の章でより詳細にカバーされている，変数宣言，式，文もしくはブロックなどについて述べています。

### 8.1. 変数の読み込みと変換

データを読み込んだり変換したりするステップは，サンプリング，最適化，診断において同じものです。

#### データを読み込む

実行の最初のステップは，データをメモリに読み込む段階です。データはファイルを通じて読み込まれたり(CmdStanにおいて)，メモリを通じて読み込まれたり(RStanやPyStan)します。詳しくはそれぞれのマニュアルを参照してください^[Stanの背後で動いているC++は，データをメモリからでもファイルからでも読むことができます。例えばRから呼び出すとき，データをファイルから読むことも，Rのメモリから直接読むようにすることもできます。]。`data`ブロックで宣言される変数は全て読みおκ希ます。もし変数が読み込めなければ，プログラムはデータ変数がないことを示すメッセージとともに停止します。

各変数が読み込まれたあと，もしそれに制約がついていれば，その定数は評価されます。例えば変数$N$が`int<lower=0>`で宣言されていれば，$N$を読み込んだ後，それが0以上であることを満たしているかどうか検証されます。もし変数が宣言された制約の要件を満たしていなければ，プログラムは不正な値を持った定数であり，変数の値が読み込まれ，制約が宣言されているという警告メッセージとともに停止します。

#### 変数変換の定義

データがモデルに読み込まれた後，変換されたデータ変数の定義に沿って，変換するデータ変数の文が実行されます。文が実行されるとき，変数につけられた制約は実行されません。

変換されたデータ変数が実数で初期化されるときは，$NaN$を初期値とし，整数の場合は最小の整数値(大きな絶対値をもつ負の数)を初期値とします。

文が実行された後，変換されたデータ変数につけられた制約が評価されます。もしこの妥当性チェックに失敗すれば，実行は停止，変数の名前と値と制約が表示されます。

### 8.2 初期化

初期化はサンプリング，最適化，診断において同じものです。

#### ユーザが初期値を与えるとき

ユーザがパラメータの初期値を提供する場合は，データの読み込みとおなじ入力メカニズム，同じファイルフォーマットをつかって読み込まれます。パラメータに対して宣言されるあらゆる制約は，初期値に対しても評価されます。もし変数の値がこの宣言された制約を違反しているようで荒れば，プログラムは中断して診断メッセージが表示されます。

読み込んだ後，初期値はサンプラーを初期化するのに使われる制約のない値に変換されます。

##### 境界の値は問題あり

Stanは制約されたものを制約されていない空間に変換するやり方を取っているので，制約の境界付近でパラメータの初期値を与えることは問題を生じやすくします。例えば次のような制約があるとします。

```
parameters {
  real<lower=0,upper=1> theta;
  //..
}
```

ここで$theta$の初期値を$0$にすると，制約されていない値としては$-¥infty$になり，一方値を$1$にすると制約されていない値としては$¥infty$になります。これは不動点の計算があれば正しく逆変換できますが，ヤコビアンが無限大になり対数尤度関数は失敗，例外を生じさせます。

#### ランダムな初期値

ユーザーから初期値が与えられなければ，デフォルトの初期化戦略は区間$(-2,2)$の一様分布から直接取ってきた値を，制限されていないパラメータに初期値として与えるというものです。この初期化の境界は変えることができますが，$0$を中心に左右対称になります。値$0$は初期値の中央値を表すものとして特別なものです。制限されていない値$0$は，パラメータ宣言の制約に合わせて異なるパラメータ値になります。

制限されていない実数はいかなる変換も含まないので，制限されてないパラメータに対する初期値$0$は制限されたパラメータに対する$0$でもあります。

下限$0$のパラメータについては，制限されていないスケールに対する初期値の$0$は，制限されたスケールにおける$exp(0)=1$に対応します。$-2$という値は，$exp(-2)=0.13$に対応しますし，$2$という値は$exp(2)=7.4$に対応します。

上限，下限の境界を持つパラメータに対しては，制限されていないスケールに対する初期値の$0$は，制限された区間の中点の値に対応します。確率的パラメータに対しては，境界は下に$0$で上に$1$ですが，これを逆ロジット変換することで，初期値である制限されていない値$0$が制限された値$0.5$に対応しますし，$-2$は$0.12$に，$2$は$0.88$に対応します。$0$と$1$以外の境界についてもスケールの調整と変換が行われます。

制限されていない基底における初期値$0$をもつシンプレックス変数は，制限された値における対称な値に対応します(すなわち，$K$-simplexは$1/K$の値を持ちます)。

正定値行列に対するコレスキー因子は，対角が$1$でそれ以外が$0$になるように初期化されます。なぜなら，対角は対数変換され，対角の下の値は制限されない値だからあです。

他のパラメータに対する初期値は適用される変換から決定されます。この変換については，34章で完全に解説sれます。


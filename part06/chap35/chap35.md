## 35　最適化アルゴリズム

StanはStanプログラムで書かれた確率密度の中央値を見つけ出す最適化アルゴリズムを提供します。この中央値はパラメータ推定地として使うことができ，またベイズ流事後分布の近似の基礎として使うことができます；30章にこの点推定の背景が論じられています。

Stanは三つの異なる最適化アルゴリズム，ニュートン法とそれに関する擬似ニュートン法であるBFGSとL-BFGSを提供しています。これについてはNocedal and Wright(2006)を参照してください。そこでこれらすべてのアルゴリズムを完全に説明，分析しています。L-BFGSアルゴリズムがデフォルトの最適化アルゴリズムです。ニュートン法は三つの手法の中で最も効率が悪いものですが，刻み幅が設定できる利点があります。

### 35.1 一般的な設定

最適化アルゴリズムはいずれも反復計算をし，反復回数の上限を設定することができます。デフォルトの最大反復回数は2000です。

最適化アルゴリズムはいずれも進捗状況を表示させることができます。反復中や進捗状況を保存するかどうかは設定できます。

### 35.2 BFGSとL-BFGSの設定

#### 収束のモニタリング

(L-)BFGSの収束を確認するのは，許容範囲の値によって制御され，それらの値のいずれかが満たされれば，アルゴリズムは解に達したとして終了します。収束の検証は，許容範囲のパラメータをゼロにすることで無効にすることができます。収束の検証は以下の通りです。

##### パラメータの収束

パラメータ$\theta_i$を第i番目の反復とすると，許容範囲を表す`tol_param`が以下のようになれば収束したとみなします。

$$|| \theta_i - \theta_{i-1} || < tol_param $$

##### 密度の収束

パラメータ$\theta_i$についての第i番目の反復で，データ$y$に対する(正規化されていない)対数密度である $\log p(\theta_i | y)$は，許容範囲`tol_obj`が以下のようになれば収束したとみなします。

$$ | \log p(\theta_i|y) - \log p(\theta_{i-1}|y) | < tol_obj $$

対数密度が収束したと見なされるのは，相対的な許容範囲が次のようになる時です。

$$ \frac{| \log p(\theta_i|y) - \log p(\theta_{i-1}|y) | }{max(| \log p(\theta_i|y)||\log p(\theta_{i-1}|y)|,10.) } < tol_rel_obj * \epsilon $$

##### 勾配の収束

勾配が0に収束したと考えられるのは，特定の許容範囲`tol_grad`が以下のようになった時です。

$$ ||g_i|| < tol_grad $$

ここで$\nabla_{\theta}$は$\theta$についての勾配演算子であり，$g_i = \nabla_{\theta} \log p(\theta_i | y)$は第i番目の反復における勾配です。

勾配が0に収束したと考えられるのは，指定された相対許容範囲`tol_rel_grad`が以下のようになった時です。

$$ \frac{g_i^T \hat{H}_i^{-1}g_i}{max(|\log p(\theta_i|y)|,1.0)} < tol_rel_grad * \epsilon $$

ここで$\hat{H}_i$は第i番目の反復におけるヘッシアン行列で，$|u|$は$u$の絶対値(L1正規化)で，$||u||$は$u$のベクトル長(L2正規化)，$\epsilon \approx 2\bar{e} - 16$は機械精度です。

#### 初期ステップサイズ

BFGS型の最適化アルゴリウムにおいて，初期ステップサイズのパラメータ$\alpha$を指定することができます。もし最初の反復に長い時間がかかるようであれば(そして多くの関数評価が求められるのであれば)，初期値$\alpha$はだいたい最初の反復で使われた$\alpha$と同じになっています。デフォルト値はかなり小さく，0.001で，これは多くの問題に対応するように設定されています。しかし目標とする関数や初期値によっては，大きすぎたり小さすぎたりするかもしれません。大きすぎたり小さすぎたりするというのは，ちょうどいい幅を見つけるまでに，最初の反復がとても長い時間を必要とする(例えば，もっと多くの購買評価が必要である)することを意味します。パラメータは深刻な問題ではありませんが，同じモデルを何回も(微調整したり，違うデータで実行したりで)最適化する場合は，実行時間を節約するためにも$\alpha$の調整ができます。